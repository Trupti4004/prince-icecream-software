<!DOCTYPE html>
<html>
<head>
    <title>Prince Ice Cream ERP</title>
    <link rel="stylesheet" href="/static/style.css">
    <script>
        let items = [];

        function addItem() {
            const productSelect = document.getElementById("product");
            const product = productSelect.value;
            const rate = parseFloat(productSelect.selectedOptions[0].dataset.rate);
            const qty = parseFloat(document.getElementById("quantity").value);

            if (!product || !qty) {
                alert("Select product and quantity");
                return;
            }

            const amount = qty * rate;

            items.push({
                product: product,
                quantity: qty,
                rate: rate,
                amount: amount
            });

            renderTable();
        }

        function renderTable() {
            let table = document.getElementById("itemsTable");
            table.innerHTML = "";
            let total = 0;

            items.forEach((i, index) => {
                total += i.amount;
                table.innerHTML += `
                    <tr>
                        <td>${i.product}</td>
                        <td>${i.quantity}</td>
                        <td>${i.rate}</td>
                        <td>${i.amount}</td>
                        <td><button type="button" onclick="removeItem(${index})">X</button></td>
                    </tr>
                `;
            });

            document.getElementById("totalAmount").innerText = total;
            document.getElementById("items_json").value = JSON.stringify(items);
        }

        function removeItem(index) {
            items.splice(index, 1);
            renderTable();
        }
    </script>
</head>

<body>

<header>
    üç¶ Prince Ice Cream ERP
    <span style="float:right">
        <a href="/logout" style="color:white">Logout</a>
    </span>
</header>

<div class="container">

<!-- PURCHASE ENTRY -->
<div class="card">
    <h3>Create Bill (Multiple Products)</h3>

    <form method="post">
        <label>Vendor</label>
        <select name="vendor" required>
            {% for v in vendors %}
            <option>{{ v[0] }}</option>
            {% endfor %}
        </select>

        <label>Date</label>
        <input type="date" name="date" required>

        <hr>

        <label>Product</label>
        <select id="product">
            {% for p in products %}
            <option value="{{ p[0] }}" data-rate="{{ p[1] }}">
                {{ p[0] }} (‚Çπ{{ p[1] }})
            </option>
            {% endfor %}
        </select>

        <label>Quantity</label>
        <input id="quantity" placeholder="Quantity">

        <button type="button" onclick="addItem()">‚ûï Add Product</button>

        <hr>

        <table border="1" width="100%">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Rate</th>
                    <th>Amount</th>
                    <th>Remove</th>
                </tr>
            </thead>
            <tbody id="itemsTable"></tbody>
        </table>

        <h3>Total: ‚Çπ <span id="totalAmount">0</span></h3>

        <input type="hidden" name="items_json" id="items_json">

        <button type="submit">üíæ Save Bill</button>
    </form>
</div>

<!-- BILL RECORDS -->
<div class="card">
    <h3>Saved Bills</h3>

    {% for p in purchases %}
    <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
        <b>Vendor:</b> {{ p[1] }} <br>
        <b>Date:</b> {{ p[2] }} <br>
        <b>Total:</b> ‚Çπ {{ p[3] }}

        <table width="100%" border="1">
            <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Rate</th>
                <th>Amount</th>
            </tr>
            {% for item in p[4] %}
            <tr>
                <td>{{ item.product }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.rate }}</td>
                <td>{{ item.amount }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endfor %}
</div>

</div>

</body>
</html>
